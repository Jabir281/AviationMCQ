<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - Aviation MCQ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css?v=20260127_1">
</head>
<body>
    <header class="admin-header">
        <div class="header-left">
            <a href="index.html" class="header-home">‚Üê Home</a>
            <h1>‚úàÔ∏è Admin Dashboard</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="dashboard-container">
            <h2>Welcome to Admin Panel</h2>
            <p class="dashboard-subtitle">Choose what you want to do</p>
            
            <!-- Settings Section -->
            <div class="settings-section" data-feature="settings" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 12px; border: 1px solid #e0e0e0;">
                <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem; color: #333;">‚öôÔ∏è System Settings</h3>
                <div class="setting-row" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <strong style="color: #333;">Single Device per Password</strong>
                        <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: #666;">When enabled, each password can only be used on one device at a time</p>
                    </div>
                    <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 34px; flex-shrink: 0;">
                        <input type="checkbox" id="singleDeviceToggle" onchange="toggleSingleDevice(this.checked)" style="opacity: 0; width: 0; height: 0;">
                        <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: 0.3s; border-radius: 34px;"></span>
                    </label>
                </div>
            </div>
            
            <div class="dashboard-cards">
                <a href="admin-questions.html" class="dashboard-card" data-feature="questions">
                    <span class="card-icon">üìù</span>
                    <h3>Question Manager</h3>
                    <p>Edit questions, set correct answers, add or delete - all in one place</p>
                    <span class="card-arrow">‚Üí</span>
                </a>

                <a href="admin-subjects.html" class="dashboard-card" data-feature="subjects">
                    <span class="card-icon">‚ûï</span>
                    <h3>Upload New Subject</h3>
                    <p>Add a new subject by uploading a JSON question file</p>
                    <span class="card-arrow">‚Üí</span>
                </a>

                <a href="admin-users.html?v=20260122_3" class="dashboard-card" data-feature="users">
                    <span class="card-icon">üë§</span>
                    <h3>User Passwords</h3>
                    <p>Create user passwords and track last seen</p>
                    <span class="card-arrow">‚Üí</span>
                </a>

                <a href="admin-admins.html" class="dashboard-card" data-feature="admins">
                    <span class="card-icon">üõ°Ô∏è</span>
                    <h3>Manage Admins</h3>
                    <p>Add additional admins for the dashboard</p>
                    <span class="card-arrow">‚Üí</span>
                </a>
            </div>
        </div>
    </main>

    <style>
        .toggle-switch input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>

    <script>
        function hasFeature(admin, feature) {
            if (!admin) return false;
            if (admin.isSuper === true) return true;
            const list = Array.isArray(admin.features) ? admin.features : [];
            return list.includes(String(feature));
        }

        function applyFeatureGating(admin) {
            const nodes = document.querySelectorAll('[data-feature]');
            nodes.forEach(el => {
                const f = el.getAttribute('data-feature');
                if (!f) return;
                if (!hasFeature(admin, f)) {
                    el.style.display = 'none';
                }
            });
        }

        async function requireApiAdmin() {
            try {
                const res = await fetch('api/admin/me.php', { cache: 'no-store', credentials: 'include' });
                if (!res.ok) throw new Error('Unauthorized');
                const data = await res.json();
                if (!data || data.ok !== true || !data.admin) throw new Error('Unauthorized');
                const admin = data.admin;
                window.__meAdmin = admin;
                applyFeatureGating(admin);
                return admin;
            } catch (_) {
                window.location.href = 'admin.html';
            }
        }

        (async () => {
            const me = await requireApiAdmin();
            if (me && hasFeature(me, 'settings')) {
                loadSettings();
            }
        })();

        async function loadSettings() {
            try {
                const res = await fetch('api/admin/settings.php', { cache: 'no-store', credentials: 'include' });
                const data = await res.json();
                if (data.ok && data.settings) {
                    const toggle = document.getElementById('singleDeviceToggle');
                    toggle.checked = data.settings.singleDevicePerUser === '1';
                }
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        async function toggleSingleDevice(enabled) {
            const toggle = document.getElementById('singleDeviceToggle');
            toggle.disabled = true;
            
            try {
                const res = await fetch('api/admin/settings.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        key: 'singleDevicePerUser',
                        value: enabled ? '1' : '0'
                    })
                });
                const data = await res.json();
                if (!data.ok) {
                    throw new Error('Failed to update setting');
                }
                // Show brief feedback
                const label = toggle.closest('.setting-row').querySelector('strong');
                const originalText = label.textContent;
                label.textContent = enabled ? '‚úì Enabled' : '‚úì Disabled';
                setTimeout(() => { label.textContent = originalText; }, 1500);
            } catch (e) {
                alert('Failed to update setting. Please try again.');
                toggle.checked = !enabled; // Revert
            } finally {
                toggle.disabled = false;
            }
        }

        async function logout() {
            try {
                await fetch('api/admin/logout.php', { cache: 'no-store' });
            } catch (_) {
                // ignore
            }
            window.location.href = 'admin.html';
        }
    </script>
</body>
</html>
