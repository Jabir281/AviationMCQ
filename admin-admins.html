<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Admins - Aviation MCQ Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css?v=20260122_3">
</head>
<body>
    <header class="admin-header">
        <div class="header-left">
            <a href="admin-dashboard.html" class="header-home">‚Üê Dashboard</a>
            <h1>üõ°Ô∏è Manage Admins</h1>
        </div>
        <div class="header-right">
            <button class="btn btn-outline-light" onclick="logout()">Logout</button>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="dashboard-container">
            <h2>Add another admin</h2>
            <p class="dashboard-subtitle">Admins can upload subjects, edit questions, and delete content. Share passwords carefully.</p>

            <div class="card" style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 16px; max-width: 720px;">
                <div class="form-group">
                    <label class="form-label" for="admin-username">Username</label>
                    <input class="form-input" id="admin-username" placeholder="e.g. admin2" maxlength="50" />
                    <div class="form-hint">3‚Äì50 chars: letters/numbers/underscore/dot/dash.</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="admin-password">Password</label>
                    <input class="form-input" id="admin-password" placeholder="6‚Äì64 characters" maxlength="64" />
                </div>

                <div class="form-group" id="features-box" style="display:none;">
                    <label class="form-label">New admin access</label>
                    <div class="form-hint">Only super admins can decide what features a new admin can access.</div>
                    <div style="display:flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="feature-check" value="questions" checked> Questions</label>
                        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="feature-check" value="subjects" checked> Subjects</label>
                        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="feature-check" value="users" checked> Users</label>
                        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="feature-check" value="admins" checked> Admins</label>
                        <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="feature-check" value="settings" checked> Settings</label>
                    </div>
                </div>

                <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-primary" id="create-admin-btn" onclick="createAdmin()">Create Admin</button>
                    <button class="btn btn-outline" onclick="loadAdmins()">Refresh List</button>
                    <span id="status" style="font-weight:600;"></span>
                </div>

                <h3 style="margin-top: 18px;">Existing admins</h3>
                <div id="admins" style="margin-top: 10px;"></div>
            </div>
        </div>
    </main>

    <!-- Edit Access Modal (super admins only) -->
    <div id="perm-modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.55); display:none; align-items: center; justify-content: center; padding: 18px; z-index: 9999;">
        <div style="width: 100%; max-width: 560px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 16px; padding: 16px;">
            <div style="display:flex; align-items:center; justify-content: space-between; gap: 12px;">
                <h3 style="margin: 0;">Edit admin access</h3>
                <button class="btn btn-outline" onclick="closePermModal()">Close</button>
            </div>
            <div class="form-hint" style="margin-top: 6px;">Admin: <strong id="perm-username"></strong></div>

            <div style="margin-top: 12px; display:flex; gap: 10px; flex-wrap: wrap;">
                <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="perm-check" value="questions"> Questions</label>
                <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="perm-check" value="subjects"> Subjects</label>
                <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="perm-check" value="users"> Users</label>
                <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="perm-check" value="admins"> Admins</label>
                <label style="display:flex; gap:8px; align-items:center;"><input type="checkbox" class="perm-check" value="settings"> Settings</label>
            </div>

            <div style="display:flex; gap: 10px; flex-wrap: wrap; align-items:center; margin-top: 14px;">
                <button class="btn btn-primary" id="perm-save-btn" onclick="savePerms()">Save Access</button>
                <button class="btn btn-outline" onclick="selectAllPerms(true)">Select all</button>
                <button class="btn btn-outline" onclick="selectAllPerms(false)">Select none</button>
                <span id="perm-status" style="font-weight:600;"></span>
            </div>
        </div>
    </div>

    <script>
        async function requireApiAdmin() {
            try {
                const res = await fetch('api/admin/me.php', { cache: 'no-store', credentials: 'include' });
                if (!res.ok) throw new Error('Unauthorized');
                const data = await res.json();
                if (!data || data.ok !== true || !data.admin) throw new Error('Unauthorized');
                const me = data.admin;
                // Only super admins can manage admins.
                if (me.isSuper !== true) {
                    window.location.href = 'admin-dashboard.html';
                    return;
                }
                document.getElementById('features-box').style.display = 'block';
            } catch (_) {
                window.location.href = 'admin.html';
            }
        }

        async function logout() {
            try { await fetch('api/admin/logout.php', { cache: 'no-store', credentials: 'include' }); } catch (_) {}
            window.location.href = 'admin.html';
        }

        function setStatus(text, ok) {
            const el = document.getElementById('status');
            el.textContent = text;
            el.style.color = ok === true ? '#2ecc71' : (ok === false ? '#ff6b6b' : '');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = String(text ?? '');
            return div.innerHTML;
        }

        function getMyAdminId() {
            return Number(window.__meAdminId || 0);
        }

        function setPermStatus(text, ok) {
            const el = document.getElementById('perm-status');
            el.textContent = text;
            el.style.color = ok === true ? '#2ecc71' : (ok === false ? '#ff6b6b' : '');
        }

        function closePermModal() {
            const modal = document.getElementById('perm-modal');
            modal.style.display = 'none';
            window.__permEditing = null;
            setPermStatus('', null);
        }

        function selectAllPerms(flag) {
            document.querySelectorAll('.perm-check').forEach(x => { x.checked = !!flag; });
        }

        function openPermModal(admin) {
            if (!admin || admin.isSuper === true) {
                setStatus('Cannot edit super admin access.', false);
                return;
            }
            window.__permEditing = { id: Number(admin.id || 0), username: String(admin.username || ''), features: Array.isArray(admin.features) ? admin.features : [] };
            document.getElementById('perm-username').textContent = window.__permEditing.username;

            const current = new Set(window.__permEditing.features.map(x => String(x)));
            document.querySelectorAll('.perm-check').forEach(x => {
                x.checked = current.has(String(x.value));
            });
            setPermStatus('', null);
            document.getElementById('perm-modal').style.display = 'flex';
        }

        async function savePerms() {
            const editing = window.__permEditing;
            if (!editing || !editing.id) return;

            const btn = document.getElementById('perm-save-btn');
            btn.disabled = true;
            setPermStatus('Saving‚Ä¶', null);

            const features = Array.from(document.querySelectorAll('.perm-check'))
                .filter(x => x && x.checked)
                .map(x => String(x.value));

            try {
                const res = await fetch('api/admin/update_admin_permissions.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId: editing.id, features }),
                    cache: 'no-store',
                    credentials: 'include'
                });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true) {
                    setPermStatus((data && data.error) ? data.error : 'Failed', false);
                    return;
                }
                setPermStatus('Saved.', true);
                await loadAdmins();
                setTimeout(() => closePermModal(), 600);
            } catch (_) {
                setPermStatus('Failed', false);
            } finally {
                btn.disabled = false;
            }
        }

        async function fetchMe() {
            const res = await fetch('api/admin/me.php', { cache: 'no-store', credentials: 'include' });
            if (!res.ok) throw new Error('Unauthorized');
            const data = await res.json();
            if (!data || data.ok !== true || !data.admin) throw new Error('Unauthorized');
            window.__meAdminId = Number(data.admin.id || 0);
            return data.admin;
        }

        function formatFeatures(a) {
            const feats = Array.isArray(a.features) ? a.features : [];
            if (a.isSuper === true) return 'ALL (Super)';
            if (feats.length === 0) return 'None';
            return feats.join(', ');
        }

        async function loadAdmins() {
            const box = document.getElementById('admins');
            box.innerHTML = '<div style="opacity:0.9;">Loading‚Ä¶</div>';

            try {
                const res = await fetch('api/admin/admins.php', { cache: 'no-store', credentials: 'include' });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true || !Array.isArray(data.admins)) {
                    box.innerHTML = '<div style="color:#ff6b6b;">Failed to load admins.</div>';
                    return;
                }

                if (data.admins.length === 0) {
                    box.innerHTML = '<div style="opacity:0.9;">No admins found.</div>';
                    return;
                }

                const meId = getMyAdminId();
                box.innerHTML = data.admins.map(a => {
                    const isMe = meId && Number(a.id) === meId;
                    return `
                        <div style="display:flex; gap:10px; align-items:center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div><strong>${escapeHtml(a.username)}</strong> ${a.isSuper ? '<span style="opacity:0.85; font-size: 0.9rem;">(super)</span>' : ''} ${isMe ? '<span style="opacity:0.85; font-size: 0.9rem;">(you)</span>' : ''}</div>
                                <div style="opacity:0.85; font-size: 0.95rem;">Created: ${escapeHtml(a.createdAt)}</div>
                                <div style="opacity:0.85; font-size: 0.95rem;">Access: ${escapeHtml(formatFeatures(a))}</div>
                            </div>
                            <div style="display:flex; gap:8px; align-items:center;">
                                ${a.isSuper ? '' : `<button class="btn btn-outline" onclick='openPermModal(${JSON.stringify({ id: Number(a.id), username: String(a.username || ''), isSuper: !!a.isSuper, features: Array.isArray(a.features) ? a.features : [] }).replace(/</g, '\\u003c')})'>üß© Edit access</button>`}
                                <button class="btn btn-outline" onclick="changeAdminPassword(${Number(a.id)})">üîë Change password</button>
                                <button class="btn btn-danger" ${isMe ? 'disabled title="You cannot revoke yourself"' : ''} onclick="revokeAdmin(${Number(a.id)}, '${escapeHtml(a.username)}')">üóëÔ∏è Revoke</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (_) {
                box.innerHTML = '<div style="color:#ff6b6b;">Failed to load admins.</div>';
            }
        }

        async function changeAdminPassword(adminId) {
            const pwd = prompt('Enter a NEW password for this admin (6‚Äì64 characters):');
            if (pwd === null) return;
            const password = String(pwd || '').trim();
            if (password.length < 6 || password.length > 64) {
                setStatus('Password must be 6-64 characters.', false);
                return;
            }

            setStatus('Updating password‚Ä¶', null);
            try {
                const res = await fetch('api/admin/change_admin_password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId, password }),
                    cache: 'no-store',
                    credentials: 'include'
                });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true) {
                    setStatus((data && data.error) ? data.error : 'Failed', false);
                    return;
                }
                setStatus('Password updated.', true);
            } catch (_) {
                setStatus('Failed', false);
            }
        }

        async function revokeAdmin(adminId, username) {
            const ok = confirm(`Revoke admin "${username}"? They will lose access to the admin dashboard.`);
            if (!ok) return;

            setStatus('Revoking‚Ä¶', null);
            try {
                const res = await fetch('api/admin/delete_admin.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ adminId }),
                    cache: 'no-store',
                    credentials: 'include'
                });
                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true) {
                    setStatus((data && data.error) ? data.error : 'Failed', false);
                    return;
                }
                setStatus('Revoked.', true);
                await loadAdmins();
            } catch (_) {
                setStatus('Failed', false);
            }
        }

        async function createAdmin() {
            const btn = document.getElementById('create-admin-btn');
            const username = String(document.getElementById('admin-username')?.value || '').trim();
            const password = String(document.getElementById('admin-password')?.value || '').trim();

            const features = Array.from(document.querySelectorAll('.feature-check'))
                .filter(x => x && x.checked)
                .map(x => String(x.value));

            if (!username || !password) {
                setStatus('Enter username and password.', false);
                return;
            }

            btn.disabled = true;
            setStatus('Creating‚Ä¶', null);

            try {
                const res = await fetch('api/admin/create_admin.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, features }),
                    cache: 'no-store',
                    credentials: 'include'
                });

                const data = await res.json().catch(() => null);
                if (!res.ok || !data || data.ok !== true) {
                    setStatus((data && data.error) ? data.error : 'Failed', false);
                    return;
                }

                setStatus(`Created admin: ${data.username}`, true);
                document.getElementById('admin-password').value = '';
                await loadAdmins();
            } catch (e) {
                setStatus('Failed', false);
            } finally {
                btn.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await requireApiAdmin();
            try { await fetchMe(); } catch (_) {}
            await loadAdmins();
        });
    </script>
</body>
</html>
